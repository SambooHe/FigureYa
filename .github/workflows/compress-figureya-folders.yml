name: Compress FigureYa Folders

on:
  schedule:
    - cron: '0 15 * * *' #  北京时间 23:00 定时触发
  workflow_dispatch: # 手动触发

jobs:
  compress-folders:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source Repo (FigureYa)
        uses: actions/checkout@v4
        with:
          repository: ying-ge/FigureYa
          path: source

      - name: Checkout Target Repo (FigureYa-compressed)
        uses: actions/checkout@v4
        with:
          repository: ying-ge/FigureYa-compressed
          token: ${{ secrets.FIGUREYA2ACTION }}
          path: target

      - name: Detect Changed Folders
        id: detect-changes
        run: |
          cd source

          # Get the current HEAD commit hash of source repo
          SOURCE_COMMIT=$(git rev-parse HEAD)

          # Get list of all FigureYa folders
          ALL_FOLDERS=$(find . -maxdepth 1 -type d -name 'FigureYa*' | sed 's|^\./||' | sort)

          # Check each folder for changes by comparing with zip file contents
          CHANGED_FOLDERS=""
          for folder in $ALL_FOLDERS; do
            echo "Checking $folder"

            # Check if corresponding zip file exists in target
            if [ -f "../target/${folder}.zip" ]; then
              # Extract and compare: create a temporary checksum of the folder
              # Get a list of files and their checksums
              FOLDER_CHECKSUM=$(find "$folder" -type f ! -name ".DS_Store" -exec sha256sum {} \; 2>/dev/null | sort | sha256sum | cut -d' ' -f1)

              # Extract the zip and get its checksum
              TEMP_EXTRACT_DIR=$(mktemp -d)
              unzip -q "../target/${folder}.zip" -d "$TEMP_EXTRACT_DIR" 2>/dev/null

              if [ -d "$TEMP_EXTRACT_DIR/$folder" ]; then
                ZIP_CHECKSUM=$(find "$TEMP_EXTRACT_DIR/$folder" -type f ! -name ".DS_Store" -exec sha256sum {} \; 2>/dev/null | sort | sha256sum | cut -d' ' -f1)

                # Compare checksums
                if [ "$FOLDER_CHECKSUM" != "$ZIP_CHECKSUM" ]; then
                  echo "  ✓ Changed folder detected: $folder"
                  CHANGED_FOLDERS="$CHANGED_FOLDERS $folder"
                else
                  echo "  ✗ Folder unchanged: $folder"
                fi
              else
                echo "  ✓ Changed (zip structure different): $folder"
                CHANGED_FOLDERS="$CHANGED_FOLDERS $folder"
              fi

              # Clean up
              rm -rf "$TEMP_EXTRACT_DIR"
            else
              # Zip file doesn't exist, need to create it
              echo "  ✓ New folder (no zip exists): $folder"
              CHANGED_FOLDERS="$CHANGED_FOLDERS $folder"
            fi
          done

          # Save changed folders to environment variable
          if [ -n "$CHANGED_FOLDERS" ]; then
            echo "CHANGED_FOLDERS=$CHANGED_FOLDERS" >> $GITHUB_ENV
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
            echo ""
            echo "Changed folders to compress:$CHANGED_FOLDERS"
          else
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
            echo "No changed folders detected"
          fi

      - name: Compress Changed Folders
        working-directory: source
        run: |
          if [ "$HAS_CHANGES" = "false" ]; then
            echo "No folders to compress"
          else
            for foldername in $CHANGED_FOLDERS; do
              zipfile="../target/${foldername}.zip"
              echo "Compressing $foldername to $zipfile"
              if [ "$foldername" = "FigureYa308IHS" ]; then
                zip -r -q "$zipfile" "$foldername" -x "$foldername/Results/out_unPruned.rds"
              else
                zip -r -q "$zipfile" "$foldername"
              fi
            done
          fi

      - name: Commit and Push Changes
        working-directory: target
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add . || true
          if git diff --staged --quiet; then
            echo "Nothing to commit"
          else
            git commit -m "Compress updated FigureYa folders [skip ci]"
            git push
          fi
