name: Compress FigureYa Folders

on:
  schedule:
    - cron: '0 15 * * *' #  北京时间 23:00 定时触发
  workflow_dispatch: # 手动触发

jobs:
  compress-folders:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source Repo (FigureYa)
        uses: actions/checkout@v4
        with:
          repository: ying-ge/FigureYa
          path: source

      - name: Checkout Target Repo (FigureYa-compressed)
        uses: actions/checkout@v4
        with:
          repository: ying-ge/FigureYa-compressed
          token: ${{ secrets.FIGUREYA2ACTION }}
          path: target

      - name: Detect Changed Folders
        id: detect-changes
        run: |
          cd source

          # Get list of all FigureYa folders
          ALL_FOLDERS=$(find . -maxdepth 1 -type d -name 'FigureYa*' | sed 's|^\./||' | sort)

          # Check each folder for changes by comparing modification times
          CHANGED_FOLDERS=""
          for folder in $ALL_FOLDERS; do
            # Get the latest modification time of any file in the source folder
            # Using find with -exec stat to avoid pipe issues
            SOURCE_TIME=$(find "$folder" -type f -exec stat -c '%Y' {} \; 2>/dev/null | sort -rn | head -n 1 || echo "0")

            # Check if corresponding zip file exists in target
            if [ -f "../target/${folder}.zip" ]; then
              # Get modification time of the zip file
              ZIP_TIME=$(stat -c '%Y' "../target/${folder}.zip" 2>/dev/null || echo "0")

              # Compare timestamps
              if [ "$SOURCE_TIME" -gt "$ZIP_TIME" ]; then
                echo "Changed folder detected: $folder (source: $SOURCE_TIME, zip: $ZIP_TIME)"
                CHANGED_FOLDERS="$CHANGED_FOLDERS $folder"
              fi
            else
              # Zip file doesn't exist, need to create it
              echo "New folder detected (no zip exists): $folder"
              CHANGED_FOLDERS="$CHANGED_FOLDERS $folder"
            fi
          done

          # Save changed folders to environment variable
          if [ -n "$CHANGED_FOLDERS" ]; then
            echo "CHANGED_FOLDERS=$CHANGED_FOLDERS" >> $GITHUB_ENV
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
            echo "Changed folders to compress:$CHANGED_FOLDERS"
          else
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
            echo "No changed folders detected"
          fi

      - name: Compress Changed Folders
        working-directory: source
        run: |
          if [ "$HAS_CHANGES" = "false" ]; then
            echo "No folders to compress"
          else
            for foldername in $CHANGED_FOLDERS; do
              zipfile="../target/${foldername}.zip"
              echo "Compressing $foldername to $zipfile"
              if [ "$foldername" = "FigureYa308IHS" ]; then
                zip -r -q "$zipfile" "$foldername" -x "$foldername/Results/out_unPruned.rds"
              else
                zip -r -q "$zipfile" "$foldername"
              fi
            done
          fi

      - name: Commit and Push Changes
        working-directory: target
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add . || true
          if git diff --staged --quiet; then
            echo "Nothing to commit"
          else
            git commit -m "Compress updated FigureYa folders [skip ci]"
            git push
          fi
